<div class="container-fluid py-4">
  <div class="d-md-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold mb-1">Gestion des Événements AGORA</h2>
      <p class="text-muted small mb-0">
        Planifiez et gérez les rassemblements, formations et réunions de la coopérative
      </p>
    </div>
    <div class="d-flex gap-3 align-items-center">
      <div class="badge bg-warning text-dark fs-6 py-2 px-3 shadow-sm">
        Total : {{ evenements.length }} événement(s)
      </div>
      <button class="btn btn-primary px-4 py-2 rounded shadow-sm" (click)="openModal()">
        <i class="bi bi-plus-circle me-2"></i>Nouvel Événement
      </button>
    </div>
  </div>

  <div class="btn-group mb-4 shadow-sm bg-white p-1 rounded border">
    <button type="button" class="btn btn-sm px-3 btn-success text-white">Tous</button>
    <button type="button" class="btn btn-sm px-3 btn-white">Planifiés</button>
    <button type="button" class="btn btn-sm px-3 btn-white">En cours</button>
    <button type="button" class="btn btn-sm px-3 btn-white">Terminés</button>
  </div>

  <div *ngIf="loading && evenements.length === 0" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2 text-muted small">Chargement des événements en cours...</p>
  </div>

  <div class="row g-4" *ngIf="!loading && evenements.length > 0">
    <div class="col-12 col-md-6 col-lg-4" *ngFor="let e of evenements">
      <div class="card shadow-sm border-0 overflow-hidden h-100">
        <div class="position-relative">
          <img
            [src]="e.image_url ? (e.image_url.startsWith('http') ? e.image_url : API_CONFIG.storageUrl + '/' + e.image_url) : 'assets/default-event.jpg'"  
            class="card-img-top"
            style="height: 180px; object-fit: cover"
          />

          <div class="position-absolute top-0 end-0 p-2">
            <span class="badge shadow-sm" 
              [ngClass]="{
                'bg-info': e.statut === 'planifie',
                'bg-warning text-dark': e.statut === 'en_cours',
                'bg-secondary': e.statut === 'termine'
              }">
              {{ e.statut | titlecase }}
            </span>
          </div>

          <div class="position-absolute bottom-0 w-100 bg-dark bg-opacity-75 text-white px-3 py-1">
            <small><i class="bi bi-geo-alt-fill me-1 text-warning"></i>{{ e.ville }} - {{ e.lieu }}</small>
          </div>
        </div>

        <div class="card-body d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="badge bg-light text-primary border-primary border">{{ e.type | uppercase }}</span>
            <small class="text-muted fw-bold">
              <i class="bi bi-calendar3 me-1"></i>{{ e.date_debut | date: 'dd/MM/yyyy HH:mm' }}
            </small>
          </div>

          <h5 class="card-title fw-bold text-dark mb-1">{{ e.titre }}</h5>
          
          <p class="card-text small text-muted mb-3">
            {{ e.description | slice:0:90 }}{{ e.description.length > 90 ? '...' : '' }}
          </p>

          <div class="p-2 bg-light rounded d-flex justify-content-between align-items-center mt-auto">
            <div>
              <span class="small text-secondary d-block" style="font-size: 0.7rem;">FRAIS D'ENTRÉE</span>
              <span class="fw-bold" [class.text-success]="e.frais_inscription === 0">
                {{ e.frais_inscription > 0 ? (e.frais_inscription + ' CFA') : 'GRATUIT' }}
              </span>
            </div>
            <div class="text-end">
              <span class="small text-secondary d-block" style="font-size: 0.7rem;">PLACES</span>
              <span class="fw-bold text-dark">{{ e.places_disponibles || 'Illimité' }}</span>
            </div>
          </div>
        </div>

        <div class="card-footer bg-white border-top-0 p-3">
          <div class="row g-2">
            <div class="col-6">
              <button class="btn btn-outline-primary btn-sm w-100 py-2" (click)="editEvent(e)">
                <i class="bi bi-pencil me-1"></i> Modifier
              </button>
            </div>
            <div class="col-6">
              <button class="btn btn-danger btn-sm w-100 py-2 text-white shadow-sm" (click)="deleteEvent(e)">
                <i class="bi bi-trash me-1"></i> Supprimer
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade show" tabindex="-1" *ngIf="showModal" style="display: block; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px)">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content shadow border-0 rounded-4">
        <div class="modal-header bg-dark text-white rounded-top-4">
          <h5 class="modal-title fw-bold">{{ isEditMode ? 'Modifier l\'événement' : 'Nouvel Événement' }}</h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeModal()"></button>
        </div>

        <div class="modal-body p-4" style="max-height: 80vh; overflow-y: auto;">
          <form [formGroup]="eventForm" (ngSubmit)="onSubmit()">
            <div class="row g-3">
              <div class="col-md-8">
                <label class="form-label fw-bold small">Titre de l'événement *</label>
                <input type="text" class="form-control" formControlName="titre" placeholder="Ex: Assemblée Générale" />
              </div>

              <div class="col-md-4">
                <label class="form-label fw-bold small">Type</label>
                <select class="form-select" formControlName="type">
                  <option value="assemblee">Assemblée</option>
                  <option value="reunion">Réunion</option>
                  <option value="formation">Formation</option>
                  <option value="atelier">Atelier</option>
                  <option value="autre">Autre</option>
                </select>
              </div>

              <div class="col-12">
                <label class="form-label fw-bold small">Description détaillée</label>
                <textarea class="form-control" rows="2" formControlName="description"></textarea>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-bold small">Date de début *</label>
                <input type="datetime-local" class="form-control" formControlName="date_debut" />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold small">Date de fin (Optionnel)</label>
                <input type="datetime-local" class="form-control" formControlName="date_fin" />
              </div>

              <div class="col-md-4">
                <label class="form-label fw-bold small">Ville</label>
                <input type="text" class="form-control" formControlName="ville" placeholder="Ex: Douala" />
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold small">Lieu / Salle *</label>
                <input type="text" class="form-control" formControlName="lieu" placeholder="Ex: Salle des fêtes" />
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold small">Adresse précise</label>
                <input type="text" class="form-control" formControlName="adresse" placeholder="Quartier, Rue..." />
              </div>

              <div class="col-md-4">
                <label class="form-label fw-bold small">Frais d'inscription (CFA)</label>
                <input type="number" class="form-control" formControlName="frais_inscription" />
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold small">Nombre de places</label>
                <input type="number" class="form-control" formControlName="places_disponibles" placeholder="Illimité" />
              </div>
              <div class="col-md-4 d-flex align-items-end pb-2">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="paySwitch" formControlName="paiement_obligatoire">
                  <label class="form-check-label small fw-bold" for="paySwitch">Paiement Requis</label>
                </div>
              </div>

              <div class="col-12">
                <label class="form-label fw-bold small text-primary">Instructions pour les participants</label>
                <textarea class="form-control" rows="2" formControlName="instructions" placeholder="Documents à apporter, tenue, etc..."></textarea>
              </div>

              <div class="col-12">
                <label class="form-label fw-bold small">Affiche de l'événement</label>
                <input type="file" class="form-control" (change)="onFileSelected($event)" accept="image/*" />
                
                <div *ngIf="imagePreview" class="mt-2 text-center position-relative">
                  <img [src]="imagePreview" class="rounded border shadow-sm" style="max-height: 150px; width: 100%; object-fit: contain; background: #eee;">
                  <p class="small text-muted mt-1" *ngIf="isEditMode && !selectedFile">Image actuelle (Laissez vide pour conserver)</p>
                </div>
              </div>
            </div>

            <div class="modal-footer px-0 pb-0 pt-4 border-top-0">
              <button type="button" class="btn btn-light px-4" (click)="closeModal()">Annuler</button>
              <button type="submit" class="btn px-5 shadow-sm" 
                [ngClass]="isEditMode ? 'btn-primary' : 'btn-success'"
                [disabled]="eventForm.invalid || loading">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
                {{ isEditMode ? 'Mettre à jour' : 'Enregistrer l\'Événement' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade show" tabindex="-1" *ngIf="showDeleteModal" style="display: block; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 400px;">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-body p-4 text-center">
          <div class="mb-3 text-danger">
            <i class="bi bi-exclamation-octagon-fill" style="font-size: 3.5rem;"></i>
          </div>
          <h4 class="fw-bold text-dark">Supprimer l'événement ?</h4>
          <p class="text-muted small">
            Êtes-vous sûr de vouloir supprimer <strong>{{ eventToDelete?.titre }}</strong> ? 
            Cette action est irréversible.
          </p>
          
          <div class="d-flex gap-2 mt-4">
            <button type="button" class="btn btn-light w-100 py-2 fw-bold" (click)="closeDeleteModal()">
              Annuler
            </button>
            <button type="button" class="btn btn-danger w-100 py-2 fw-bold text-white shadow-sm" (click)="confirmDelete()">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
              Supprimer
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>